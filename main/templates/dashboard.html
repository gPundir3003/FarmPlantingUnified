{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FarmPlanting Dashboard</title>
  <link rel="stylesheet" href="{% static 'index.css' %}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background-color: #f3f8f3;
    }
  
    .top-bar {
      background-color: #d0e8d0;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ccc;
      position: relative;
    }
    
    .top-bar h2 {
      font-size: 24px;
      font-weight: bold;
      color: #2e8b57;
      margin: 0;
    }
    .profile-icon {
      width: 28px;        /* same as bell */
      height: 28px;
      object-fit: contain; 
      display: inline-block;
      border: none;
      padding: 0;
      margin: 0;
    }

    .notification-wrapper {
      position: absolute;
      right: 20px;
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .notification-wrapper img {
      width: 28px;
      height: 28px;
      
    }
    
    .notification-dot {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 10px;
      height: 10px;
      background: red;
      border-radius: 50%;
    }
    
    /* Bottom nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      display: flex;
      justify-content: space-around;
      align-items: center;   /* ‚úÖ vertically center icons like top-bar */
      padding: 10px 0;       /* make it same as top-bar */
      background: #d0e8d0;
      border-top: 1px solid #ccc;
      height: 48px;          /* ‚úÖ force same thickness as top bar */
    }
    
    .bottom-nav img {
      width: 28px;
      height: 28px;
      cursor: pointer;
      object-fit: contain;
    
    }

    .section { padding: 20px; }
    .section-title { font-size: 20px; margin-bottom: 10px; color: #2e8b57; }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 20px;
    }
    .card img { width: 100%; border-radius: 8px; }
    .crop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }
    .crop-item { text-align: center; }
    .crop-item img { width: 60px; height: 60px; object-fit: contain; }
    .bottom-nav {
      position: fixed; bottom: 0; width: 100%;
      display: flex; justify-content: space-around;
      padding: 10px 0; background: #d0e8d0; border-top: 1px solid #ccc;
    }
    textarea {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;
    }
    button[type="submit"] {
      margin-top: 10px; padding: 10px 20px; border: none;
      background-color: #2e8b57; color: white; border-radius: 8px; cursor: pointer;
    }
    #ai-response { margin-top: 15px; font-style: italic; color: #333; }
    #map-preview { height: 200px; border-radius: 8px; }
    #location-text { margin-top: 8px; font-size: 14px; color: #555; }

    /* Task manager styling */
    .tm-row {
      display: flex; gap: 12px; align-items: center;
      padding: 10px 0; border-bottom: 1px solid #f1f3f0;
    }
    .tm-row:last-child { border-bottom: 0; }
    .tm-check { width: 18px; height: 18px; cursor: pointer; }
    .tm-text { flex: 1; }
    .tm-row.done .tm-text { text-decoration: line-through; color:#7b8a78; opacity:.8; }
    .tm-meta { color:#7b8a78; font-size:12px; margin-left: 6px; }
    .tm-edit {
      padding: 6px 10px; border:1px solid #e5e9e3; border-radius:8px;
      background:#f7faf6; cursor:pointer;
    }

    /* Modal (details) */
    .modal {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.45);
      align-items:center; justify-content:center; z-index:1000;
    }
    .modal-content {
      background:#fff; border-radius:12px; padding:20px; width:360px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
    }
    .modal-content input, .modal-content textarea {
      width:100%; padding:8px; margin:8px 0; border:1px solid #ddd; border-radius:8px;
    }
    .modal-actions {
      margin-top: 6px; display:flex; gap:8px; justify-content:flex-end;
    }
    .btn-primary {
      padding:10px 12px; background:#5a7750; color:#fff; border:none; border-radius:8px; cursor:pointer;
    }
    .btn-light {
      padding:10px 12px; background:#eef3ec; color:#334; border:none; border-radius:8px; cursor:pointer;
    }
  </style>
</head>
<body>

<div class="top-bar">
  <h2>Dashboard</h2>
  <div class="notification-wrapper">
    <a href="{% url 'notifications' %}">
      <img src="{% static 'images/bell_icon.png' %}" alt="Notifications" style="width:28px;height:28px;">
      {% if unread_notifications > 0 %}
        <span class="notification-dot"></span>
      {% endif %}
    </a>
    <a href="{% url 'profile' %}">
      <img src="{% static 'images/profile_icon.png' %}" alt="Profile" style="cursor: pointer;">
    </a>
  </div>
</div>

<div class="section">
  <div class="section-title">My Plot</div>
  <div class="card" onclick="window.location.href='{% url 'layout_planning' %}'">
    <div id="map-preview"></div>
    <p id="location-text"></p>
  </div>
</div>

<div class="section">
  <div class="section-title">Crop & Field Management</div>
  <div class="card crop-grid">
    {% for crop in user_crops %}
      <div class="crop-item">
        <img src="{{ crop.clipart.url }}" alt="{{ crop.name }}">
        <p><strong>{{ crop.name }}</strong><br>{{ crop.harvest_time }}</p>
      </div>
    {% empty %}
      <p>No crops added yet.</p>
    {% endfor %}
  </div>
</div>

<div class="section">
  <div class="section-title">Task Management</div>
  <div class="card" id="tm-list">
    {% if tasks %}
      {% for t in tasks %}
        <div class="tm-row {% if t.is_done %}done{% endif %}" data-id="{{ t.id }}">
          <input type="checkbox" class="tm-check" {% if t.is_done %}checked{% endif %} />
          <div class="tm-text">
            ‚úèÔ∏è {{ t.description }}
            <span class="tm-meta">
              {% if t.date %} ‚Ä¢ {{ t.date|date:"d M Y" }}{% endif %}
              {% if t.time %} ‚Ä¢ {{ t.time }}{% endif %}
            </span>
          </div>
          <button class="tm-edit">Details</button>
        </div>
      {% endfor %}
    {% else %}
      <p>No tasks available.</p>
    {% endif %}
  </div>
</div>

<div class="section">
  <div class="section-title">AI Crop Assistant</div>
  <div class="card">
    <form id="ai-form">
      <textarea id="user-question" rows="3" placeholder="Ask about your crops..."></textarea>
      <button type="submit">Get Advice</button>
    </form>
    <div id="ai-response"></div>
  </div>
</div>

<div class="bottom-nav">
  <a href="{% url 'dashboard' %}"><img src="{% static 'images/home_icon.png' %}" alt="Home"></a>
  <a href="{% url 'layout_planning' %}"><img src="{% static 'images/maps_icon.jpeg' %}" alt="Plot"></a>
  <a href="{% url 'crop_list' %}"><img src="{% static 'images/plants_icon.png' %}" alt="Crops"></a>
  <a href="{% url 'calendar' %}"><img src="{% static 'images/calender_icon.jpg' %}" alt="Calendar"></a>
  <a href="{% url 'weather' %}"><img src="{% static 'images/weather.png' %}" alt="Weather" style="width: 28px; height: 28px;" /></a>
</div>

<!-- Details Modal -->
<div id="tmModal" class="modal">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <h3 style="margin:0;">Edit Task</h3>
      <button id="tmClose" class="btn-light" style="background:transparent;font-size:20px;">√ó</button>
    </div>
    <input id="tmDate" type="date">
    <input id="tmTime" type="text" placeholder="Time (e.g., 08:00 AM)">
    <input id="tmDesc" type="text" placeholder="Description">
    <textarea id="tmNotes" placeholder="Notes (optional)" style="min-height:90px;"></textarea>
    <div class="modal-actions">
      <button id="tmSave" class="btn-primary">Save</button>
    </div>
  </div>
</div>

<script>
/* ---------- CSRF helper (cookie) ---------- */
function getCookie(name){
  const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}
const CSRF = getCookie('csrftoken');

/* ---------- AI assistant ---------- */
document.getElementById('ai-form').addEventListener('submit', function (e) {
  e.preventDefault();
  const question = document.getElementById('user-question').value;
  const answerDiv = document.getElementById('ai-response');
  answerDiv.innerText = 'Thinking...';

  fetch('/ai-crop-assistant/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF },
    body: JSON.stringify({ message: question })
  })
  .then(r => r.json())
  .then(data => { answerDiv.innerText = data.response; })
  .catch(() => { answerDiv.innerText = 'Error talking to the assistant.'; });
});

/* ---------- Map preview ---------- */
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(function(position) {
    var lat = position.coords.latitude;
    var lon = position.coords.longitude;

    var map = L.map('map-preview').setView([lat, lon], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    L.marker([lat, lon]).addTo(map);

    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
      .then(response => response.json())
      .then(data => {
        const address = data.display_name;
        document.getElementById('location-text').innerText = `üìç ${address}`;
      })
      .catch(() => {
        document.getElementById('location-text').innerText = `üìç Coordinates: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      });
  }, function() {
    document.getElementById('location-text').innerText = "Location access denied.";
  });
} else {
  document.getElementById('location-text').innerText = "Geolocation not supported.";
}

/* ---------- Task manager: tick + details ---------- */
const tmList  = document.getElementById('tm-list');
const modal   = document.getElementById('tmModal');
const tmClose = document.getElementById('tmClose');
const tmSave  = document.getElementById('tmSave');
const fDate   = document.getElementById('tmDate');
const fTime   = document.getElementById('tmTime');
const fDesc   = document.getElementById('tmDesc');
const fNotes  = document.getElementById('tmNotes');

let currentId = null;

// Toggle checkbox
tmList.addEventListener('change', async (e)=>{
  if(!e.target.classList.contains('tm-check')) return;
  const row = e.target.closest('.tm-row');
  const id  = row.dataset.id;
  const is_done = e.target.checked;

  const res = await fetch("{% url 'toggle_task' %}", {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':CSRF},
    body:JSON.stringify({id:id, is_done:is_done})
  });
  if(res.ok){
    row.classList.toggle('done', is_done);
  }else{
    e.target.checked = !is_done;
    alert('Could not update');
  }
});

// Open details modal
tmList.addEventListener('click', async (e)=>{
  if(!e.target.classList.contains('tm-edit')) return;
  const row = e.target.closest('.tm-row');
  currentId = row.dataset.id;

  // fetch full info
  const resp = await fetch("{% url 'tasks_all_json' %}");
  const j = await resp.json();
  const t = (j.ok && j.tasks) ? j.tasks.find(x=>String(x.id)===String(currentId)) : null;
  if(!t){ alert('Task not found'); return; }

  fDate.value = t.date;
  fTime.value = t.time || '';
  fDesc.value = t.description || '';
  fNotes.value = t.notes || '';

  modal.style.display = 'flex';
});

tmClose.onclick = ()=> modal.style.display='none';
window.addEventListener('click',(e)=>{ if(e.target===modal) modal.style.display='none' });

</script>

</body>
</html>
